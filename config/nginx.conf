server {
    listen 80;
    server_name iekava.lv *.iekava.lv;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name iekava.lv *.iekava.lv;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header Content-Security-Policy "default-src 'self' www.google-analytics.com ajax.googleapis.com www.google.com google.com gstatic.com www.gstatic.com connect.facebook.net facebook.com;";
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "origin";

    ssl_certificate /etc/letsencrypt/live/iekava.lv/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/iekava.lv/privkey.pem;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    # SSL configuration (based on Let's Encrypt options)
    ssl_session_cache shared:le_nginx_SSL:10m;
    ssl_session_timeout 1440m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    
    # Only 256-bit ciphers for TLS 1.2
    ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES256-GCM-SHA384";
    
    # Only 256-bit ciphers for TLS 1.3
    ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256;
    
    set $subdomain "@";
    if ($host ~ ^([^.]+)\.iekava\.lv$) {
        set $subdomain $1;
    }

    location / {
        content_by_lua_block {
            local subdomain = ngx.var.subdomain or "@"
            local config_path = "/home/mikelis.kalme/iekava.lv/webserver/" .. subdomain .. "/config.lua"
            local static_page_server_path = "/home/mikelis.kalme/iekava.lv/script/static_page_server.lua"

            local chunk, load_err = loadfile(config_path)
            if chunk then
                local ok, run_err = pcall(chunk)
                if not ok then
                    ngx.log(ngx.ERR, "Error running config.lua: ", run_err)
                end
            else
                local static_chunk, static_err = loadfile(static_page_server_path)
                if not static_chunk then
                    ngx.log(ngx.ERR, "Failed to load static_page_server.lua: ", static_err)
                end

                local static_page_server = static_chunk()
                local base_path = "/home/mikelis.kalme/iekava.lv/webserver/" .. subdomain .. "/web"
                local error_base_path = "/home/mikelis.kalme/iekava.lv/error"
                static_page_server(base_path, error_base_path)
            end
        }
    }
}